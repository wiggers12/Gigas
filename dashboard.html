<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DashControl Business - Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { margin:0; font-family:'Poppins', sans-serif; background:#0d0d0d; color:white; }
    header { background:linear-gradient(90deg,#8e44ad,#b8860b); padding:15px; font-size:22px; font-weight:700; text-align:center; }
    .chart-card { background:#1a1a1a; border-radius:12px; padding:15px; margin:20px auto; box-shadow:0 4px 20px rgba(0,0,0,0.6); max-width:1200px; }
    .chart { width:100%; height:400px; }
    .no-data-message { text-align: center; color: #aaa; padding: 20px; }
  </style>
</head>
<body>

<header>ðŸ“Š DashControl Business - Dashboard</header>

<div class="chart-card"><div id="chartVendas" class="chart"></div></div>
<div class="chart-card"><div id="chartEstoque" class="chart"></div></div>
<div class="chart-card"><div id="chartFinanceiro" class="chart"></div></div>
<div class="chart-card"><div id="chartPagamentos" class="chart"></div></div>
<div class="chart-card"><div id="chartLinha" class="chart"></div></div>

<script type="module">
  // ImportaÃ§Ã£o do Firebase
  import { db } from "./firebase.js";
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // Cache para as instÃ¢ncias do ECharts
  const charts = {};

  function renderChart(elementId, option) {
    if (!charts[elementId]) {
      charts[elementId] = echarts.init(document.getElementById(elementId));
      window.addEventListener("resize", () => charts[elementId].resize());
    }
    charts[elementId].setOption(option);
  }

  function showNoDataMessage(elementId, message) {
    const element = document.getElementById(elementId);
    if (element) {
      element.innerHTML = `<div class="no-data-message">${message}</div>`;
    }
  }

  async function carregarDados() {
    try {
      // ðŸ”¹ Vendas
      const vendasSnap = await getDocs(collection(db, "vendas"));
      let vendas = vendasSnap.docs.map(doc => doc.data());

      // ðŸ”¹ Estoque
      const estoqueSnap = await getDocs(collection(db, "estoque"));
      let estoque = estoqueSnap.docs.map(doc => doc.data());

      // ðŸ”¹ Financeiro
      const finSnap = await getDocs(collection(db, "financeiro"));
      let financeiro = finSnap.docs.map(doc => doc.data());

      montarGraficos(vendas, estoque, financeiro);
    } catch (e) {
      console.error("Erro ao carregar os dados: ", e);
      alert("Erro ao carregar os dados. Verifique sua conexÃ£o ou a configuraÃ§Ã£o do Firebase.");
    }
  }

  function montarGraficos(vendas, estoque, financeiro) {
    // ðŸ›’ Vendas por Produto (contagem)
    if (vendas.length > 0) {
      let contagemVendasPorProduto = {};
      vendas.forEach(v => {
        const produtoNome = v.produto;
        if (produtoNome) {
          contagemVendasPorProduto[produtoNome] = (contagemVendasPorProduto[produtoNome] || 0) + 1;
        }
      });
      const produtosData = Object.keys(contagemVendasPorProduto).map(p => ({
        name: p,
        value: contagemVendasPorProduto[p]
      }));

      renderChart("chartVendas", {
        title:{text:"ðŸ›’ Vendas por Produto (Contagem)", textStyle:{color:'#d4af37'}},
        tooltip: { trigger: 'item', formatter: "{b}: {c} unidades" },
        series:[{type:"pie", radius:["40%","70%"], data:produtosData, label:{color:'#fff'}}]
      });
    } else {
      showNoDataMessage("chartVendas", "Nenhuma venda registrada.");
    }

    // ðŸ“¦ Estoque Atual
    if (estoque.length > 0) {
      const estoqueNomes = estoque.map(e => e.nome);
      const estoqueQtds = estoque.map(e => e.quantidade || 0);
      renderChart("chartEstoque", {
        title:{text:"ðŸ“¦ Estoque Atual", textStyle:{color:'#d4af37'}},
        tooltip: { trigger: 'item' },
        xAxis:{type:"category", data:estoqueNomes, axisLabel:{color:'#fff'}},
        yAxis:{type:"value", axisLabel:{color:'#fff'}},
        series:[{type:"bar", data:estoqueQtds, itemStyle:{color:"#1abc9c"}, label:{show:true, color:"#fff"}}]
      });
    } else {
      showNoDataMessage("chartEstoque", "Nenhum produto no estoque.");
    }

    // ðŸ’° Financeiro (Entradas x SaÃ­das)
    if (financeiro.length > 0) {
      const entradas = financeiro.reduce((s,f)=>s+(f.entrada||0),0);
      const saidas = financeiro.reduce((s,f)=>s+(f.saida||0),0);
      renderChart("chartFinanceiro", {
        title:{text:"ðŸ’° Entradas x SaÃ­das", textStyle:{color:'#d4af37'}},
        tooltip: { trigger: 'item' },
        series:[{type:"pie", radius:["40%","70%"], data:[{name:"Entradas", value:entradas},{name:"SaÃ­das", value:saidas}], label:{color:'#fff'}}]
      });
    } else {
      showNoDataMessage("chartFinanceiro", "Nenhum dado financeiro.");
    }

    // ðŸ’³ Formas de Pagamento
    if (vendas.length > 0) {
      let formas = {};
      vendas.forEach(v => formas[v.pagamento] = (formas[v.pagamento] || 0) + v.valor);
      const pagamentosData = Object.keys(formas).map(f => ({
        name: f,
        value: formas[f]
      }));
      renderChart("chartPagamentos", {
        title:{text:"ðŸ’³ Formas de Pagamento", textStyle:{color:'#d4af37'}},
        tooltip: { trigger: 'item' },
        series:[{type:"pie", radius:["40%","70%"], data:pagamentosData, label:{color:"#fff"}}]
      });
    } else {
      showNoDataMessage("chartPagamentos", "Nenhuma venda registrada.");
    }

    // ðŸ“ˆ Receita ao Longo do Tempo
    if (vendas.length > 0) {
      let porData = {};
      vendas.forEach(v => { porData[v.data] = (porData[v.data] || 0) + v.valor; });
      const datas = Object.keys(porData).sort();
      const valores = datas.map(d => porData[d]);

      renderChart("chartLinha", {
        title:{text:"ðŸ“ˆ Receita ao Longo do Tempo", textStyle:{color:'#d4af37'}},
        tooltip: { trigger: 'axis' },
        xAxis:{type:"category", data:datas, axisLabel:{color:'#fff'}},
        yAxis:{type:"value", axisLabel:{color:'#fff'}},
        series:[{type:"line", data:valores, smooth:true, itemStyle:{color:"#d4af37"}}]
      });
    } else {
      showNoDataMessage("chartLinha", "Nenhuma venda para exibir a receita.");
    }
  }

  carregarDados();
</script>

</body>
</html>
