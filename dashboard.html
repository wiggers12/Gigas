<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DashControl Business - Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body { margin:0; font-family:'Poppins', sans-serif; background:#0d0d0d; color:white; }
    header { background:linear-gradient(90deg,#8e44ad,#b8860b); padding:15px; font-size:22px; font-weight:700; text-align:center; }
    .chart-card { background:#1a1a1a; border-radius:12px; padding:15px; margin:20px auto; box-shadow:0 4px 20px rgba(0,0,0,0.6); max-width:1200px; }
    .chart { width:100%; height:400px; }
  </style>
</head>
<body>

<header>ðŸ“Š DashControl Business - Dashboard</header>

<div class="chart-card"><div id="chartVendas" class="chart"></div></div>
<div class="chart-card"><div id="chartEstoque" class="chart"></div></div>
<div class="chart-card"><div id="chartFinanceiro" class="chart"></div></div>
<div class="chart-card"><div id="chartPagamentos" class="chart"></div></div>
<div class="chart-card"><div id="chartLinha" class="chart"></div></div>

<script type="module">
  // ImportaÃ§Ã£o do Firebase
  import { db } from "./firebase.js";
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  function renderChart(elementId, option) {
    const chart = echarts.init(document.getElementById(elementId));
    chart.setOption(option);
    window.addEventListener("resize", () => chart.resize());
  }

  async function carregarDados() {
    try {
      // ðŸ”¹ Vendas
      const vendasSnap = await getDocs(collection(db, "vendas"));
      let vendas = [];
      vendasSnap.forEach(doc => vendas.push(doc.data()));

      // ðŸ”¹ Estoque
      const estoqueSnap = await getDocs(collection(db, "estoque"));
      let estoque = [];
      estoqueSnap.forEach(doc => estoque.push(doc.data()));

      // ðŸ”¹ Financeiro
      const finSnap = await getDocs(collection(db, "financeiro"));
      let financeiro = [];
      finSnap.forEach(doc => financeiro.push(doc.data()));

      montarGraficos(vendas, estoque, financeiro);
    } catch (e) {
      console.error("Erro ao carregar os dados: ", e);
      alert("Erro ao carregar os dados. Verifique sua conexÃ£o ou a configuraÃ§Ã£o do Firebase.");
    }
  }

  function montarGraficos(vendas, estoque, financeiro) {
    // Vendas por Produto
    if (vendas.length > 0) {
      let vendasPorProduto = {};
      vendas.forEach(v => vendasPorProduto[v.produto] = (vendasPorProduto[v.produto] || 0) + v.valor);

      renderChart("chartVendas", {
        title:{text:"ðŸ›’ Vendas por Produto", textStyle:{color:'#d4af37'}},
        xAxis:{type:"category", data:Object.keys(vendasPorProduto), axisLabel:{color:'#fff'}},
        yAxis:{type:"value", axisLabel:{color:'#fff'}},
        series:[{type:"bar", data:Object.values(vendasPorProduto), itemStyle:{color:"#8e44ad"}, label:{show:true, color:"#fff"}}]
      });
    }

    // Estoque Atual
    if (estoque.length > 0) {
      renderChart("chartEstoque", {
        title:{text:"ðŸ“¦ Estoque Atual", textStyle:{color:'#d4af37'}},
        xAxis:{type:"category", data:estoque.map(e=>e.nome), axisLabel:{color:'#fff'}},
        yAxis:{type:"value", axisLabel:{color:'#fff'}},
        series:[{type:"bar", data:estoque.map(e=>e.quantidade ?? 0), itemStyle:{color:"#1abc9c"}, label:{show:true, color:"#fff"}}]
      });
    }

    // Financeiro (Entradas x SaÃ­das)
    if (financeiro.length > 0) {
      let entradas = financeiro.reduce((s,f)=>s+(f.entrada||0),0);
      let saidas = financeiro.reduce((s,f)=>s+(f.saida||0),0);
      renderChart("chartFinanceiro", {
        title:{text:"ðŸ’° Entradas x SaÃ­das", textStyle:{color:'#d4af37'}},
        xAxis:{type:"category", data:["Entradas","SaÃ­das"], axisLabel:{color:'#fff'}},
        yAxis:{type:"value", axisLabel:{color:'#fff'}},
        series:[{type:"bar", data:[entradas,saidas], itemStyle:{color:"#b8860b"}, label:{show:true, color:"#fff"}}]
      });
    }

    // Formas de Pagamento
    if (vendas.length > 0) {
      let formas = {};
      vendas.forEach(v => formas[v.pagamento]=(formas[v.pagamento]||0)+v.valor);
      renderChart("chartPagamentos", {
        title:{text:"ðŸ’³ Formas de Pagamento", textStyle:{color:'#d4af37'}},
        series:[{type:"pie", radius:["40%","70%"], data:Object.keys(formas).map(f=>({name:f,value:formas[f]})), label:{color:"#fff"}}]
      });
    }

    // Receita ao Longo do Tempo
    if (vendas.length > 0) {
      let porData = {};
      vendas.forEach(v => { porData[v.data]=(porData[v.data]||0)+v.valor; });
      renderChart("chartLinha", {
        title:{text:"ðŸ“ˆ Receita ao Longo do Tempo", textStyle:{color:'#d4af37'}},
        xAxis:{type:"category", data:Object.keys(porData), axisLabel:{color:'#fff'}},
        yAxis:{type:"value", axisLabel:{color:'#fff'}},
        series:[{type:"line", data:Object.values(porData), smooth:true, itemStyle:{color:"#d4af37"}}]
      });
    }
  }

  carregarDados();
</script>

</body>
</html>
