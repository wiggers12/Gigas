<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DashControl Business - Dados</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { margin:0; font-family:'Poppins', sans-serif; background:#0d0d0d; color:white; }
    header { background:linear-gradient(90deg,#8e44ad,#b8860b); padding:15px; font-size:22px; font-weight:700; text-align:center; }
    h2 { color:#d4af37; margin:20px 0; text-align:center; }
    section { background:#1a1a1a; padding:20px; margin:20px auto; border-radius:12px; max-width:900px; box-shadow:0 4px 20px rgba(0,0,0,0.6); }
    label { display:block; margin:10px 0 5px; font-weight:600; color:#d4af37; }
    input, select { padding:10px; border-radius:6px; border:none; width:100%; background:#2c2c2c; color:white; font-size:14px; }
    .actions { text-align:center; margin-top:15px; }
    button { background:#8e44ad; padding:12px 20px; margin:8px; border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer; transition:0.3s; }
    button:hover { background:#b8860b; transform:scale(1.05); }
  </style>
</head>
<body>

<header>⚙️ DashControl Business - Inserção de Dados</header>

<!-- Registrar Venda -->
<section>
  <h2>🛒 Registrar Venda</h2>
  <label>Produto/Serviço:</label>
  <select id="vendaProduto"></select>

  <label>Valor (R$):</label>
  <input type="number" id="vendaValor" readonly>

  <label>Forma de Pagamento:</label>
  <select id="vendaPagamento">
    <option value="Pix">⚡ Pix</option>
    <option value="Débito">💳 Débito</option>
    <option value="Crédito">💳 Crédito</option>
    <option value="Dinheiro">💵 Dinheiro</option>
  </select>

  <label>Data da Venda:</label>
  <input type="date" id="vendaData">

  <div class="actions">
    <button onclick="registrarVenda()">💾 Registrar Venda</button>
  </div>
</section>

<!-- Cadastro de Produtos -->
<section>
  <h2>📦 Cadastro de Produtos/Serviços</h2>
  <label>Nome:</label>
  <input type="text" id="estoqueNome">

  <label>Valor Unitário (R$):</label>
  <input type="number" id="estoqueValor">

  <label>Quantidade (deixe vazio se for serviço):</label>
  <input type="number" id="estoqueQtd">

  <div class="actions">
    <button onclick="adicionarProduto()">➕ Adicionar Produto</button>
  </div>
</section>

<!-- Financeiro -->
<section>
  <h2>💰 Financeiro</h2>
  <label>Caixa Inicial (R$):</label>
  <input type="number" id="caixaInicial">

  <div class="actions">
    <button onclick="definirCaixa()">📌 Definir Caixa Inicial</button>
  </div>
</section>

<script type="module">
  import { db } from "./firebase.js";
  import { collection, addDoc, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const selVendaProduto = document.getElementById("vendaProduto");
  const vendaValor = document.getElementById("vendaValor");

  // 🔹 Carregar produtos do Firestore
  async function carregarProdutos() {
    selVendaProduto.innerHTML = "";
    const snapshot = await getDocs(collection(db, "estoque"));
    snapshot.forEach((d) => {
      const p = d.data();
      let opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = `${p.nome} - R$${p.valor.toFixed(2)} (Qtd: ${p.quantidade ?? "Serviço"})`;
      opt.setAttribute("data-valor", p.valor);
      selVendaProduto.appendChild(opt);
    });
    if (selVendaProduto.options.length > 0) {
      vendaValor.value = selVendaProduto.options[0].getAttribute("data-valor");
    }
  }

  selVendaProduto.addEventListener("change", () => {
    let valor = selVendaProduto.options[selVendaProduto.selectedIndex].getAttribute("data-valor");
    vendaValor.value = valor;
  });

  // 🔹 Adicionar produto ao estoque
  async function adicionarProduto() {
    let nome = document.getElementById("estoqueNome").value;
    let valor = parseFloat(document.getElementById("estoqueValor").value) || 0;
    let qtd = document.getElementById("estoqueQtd").value;
    let quantidade = qtd === "" ? null : parseInt(qtd);

    if (!nome || valor <= 0) {
      alert("⚠️ Preencha nome e valor!");
      return;
    }

    await addDoc(collection(db, "estoque"), { nome, valor, quantidade });
    alert("✅ Produto adicionado!");
    document.getElementById("estoqueNome").value = "";
    document.getElementById("estoqueValor").value = "";
    document.getElementById("estoqueQtd").value = "";
    carregarProdutos();
  }

  // 🔹 Registrar Venda
  async function registrarVenda() {
    let prodId = selVendaProduto.value;
    let valor = parseFloat(vendaValor.value) || 0;
    let pagamento = document.getElementById("vendaPagamento").value;
    let data = document.getElementById("vendaData").value || new Date().toISOString().split("T")[0];

    if (!prodId) {
      alert("⚠️ Selecione um produto!");
      return;
    }

    // Registra venda
    await addDoc(collection(db, "vendas"), { prodId, valor, pagamento, data });
    alert("✅ Venda registrada!");

    // Atualiza financeiro
    await addDoc(collection(db, "financeiro"), { entrada: valor, saida: 0, data });

    // Atualiza estoque (reduz 1 unidade se não for serviço)
    const snapshot = await getDocs(collection(db, "estoque"));
    snapshot.forEach(async (d) => {
      if (d.id === prodId) {
        let produto = d.data();
        if (produto.quantidade !== null && produto.quantidade > 0) {
          await updateDoc(doc(db, "estoque", d.id), { quantidade: produto.quantidade - 1 });
        }
      }
    });

    carregarProdutos();
  }

  // 🔹 Definir caixa inicial
  async function definirCaixa() {
    let inicial = parseFloat(document.getElementById("caixaInicial").value) || 0;
    let data = new Date().toISOString().split("T")[0];
    await addDoc(collection(db, "financeiro"), { entrada: inicial, saida: 0, data });
    alert("✅ Caixa inicial definido!");
  }

  // Inicializar
  carregarProdutos();
  document.getElementById("vendaData").value = new Date().toISOString().split("T")[0];
</script>

</body>
</html>